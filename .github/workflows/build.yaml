name: Build Docker Container
on:
  workflow_call:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  docker_build:
    runs-on: ubuntu-latest
    # Define permissions to allow pushing to ghcr.io
    permissions:
      contents: read
      packages: write # Crucial for pushing to the Container Registry

    env:
      DJANGO_SECRET_KEY: test-key-dvfrwe4wsF#2&&^dsf
      # 1. Consistent local tag
      LOCAL_IMAGE_TAG: gradpad-be:${{ github.sha }}
      # 2. Base path for the remote registry
      REMOTE_IMAGE_PATH: ghcr.io/mananrg/gradpadfinder/gradpad-be

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build the Docker image
        # Builds the image with the unique SHA tag
        run: docker build . --file Dockerfile --tag ${{ env.LOCAL_IMAGE_TAG }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and Push Docker image
        run: |
          # 1. Tag the image with the permanent, unique SHA tag
          SHA_TAG=${{ env.REMOTE_IMAGE_PATH }}:${{ github.sha }}
          docker tag ${{ env.LOCAL_IMAGE_TAG }} $SHA_TAG

          # 2. Tag the image with the rolling 'latest' tag
          LATEST_TAG=${{ env.REMOTE_IMAGE_PATH }}:latest
          docker tag ${{ env.LOCAL_IMAGE_TAG }} $LATEST_TAG

          # 3. Push BOTH tags
          echo "Pushing permanent tag: $SHA_TAG"
          docker push $SHA_TAG

          echo "Pushing latest tag: $LATEST_TAG"
          docker push $LATEST_TAG
